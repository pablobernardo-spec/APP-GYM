<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE VANGUARD - Master Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap');
        
        :root {
            --primary: #2563eb; --secondary: #10b981; --accent: #f59e0b;
            --danger: #ef4444; --dark: #0f172a; --card-bg: #ffffff; --border: #e2e8f0;
            --indigo: #6366f1; --water: #0ea5e9; --purple: #a855f7; --epi: #f43f5e;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif; background: #0f172a;
            background-image: radial-gradient(circle at 10% 10%, #1e3a8a 0%, transparent 30%), 
                              radial-gradient(circle at 90% 90%, #1e1b4b 0%, transparent 30%);
            min-height: 100vh; color: var(--dark); background-attachment: fixed;
        }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        header { text-align: center; color: white; padding: 10px 0; }
        h1 { font-size: 1.4rem; font-weight: 900; background: linear-gradient(to right, #fff, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* NAVEGACI√ìN INFERIOR (Mobile First) */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 5px; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.6rem; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s; }
        .nav-btn.active { color: white; }
        .nav-btn .icon { font-size: 1.2rem; }

        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 24px; padding: 18px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .card-title { font-size: 0.95rem; margin-bottom: 12px; font-weight: 900; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; }

        /* COACH VOICE & AI */
        .coach-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border-left: 6px solid var(--indigo); overflow: hidden; }
        .epi-badge { position: absolute; top: 15px; right: 15px; background: var(--epi); color: white; padding: 4px 10px; border-radius: 12px; font-weight: 900; font-size: 0.7rem; box-shadow: 0 0 15px rgba(244, 63, 94, 0.4); }

        /* INPUTS */
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .input-group { background: #f8fafc; padding: 10px; border-radius: 14px; border: 1px solid #e2e8f0; }
        .input-group label { display: block; font-size: 0.5rem; font-weight: 900; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; border: none; background: transparent; font-size: 0.9rem; font-weight: 700; color: var(--dark); }

        /* MUSCLE HEATMAP */
        .heatmap-container { display: flex; justify-content: center; margin: 15px 0; }
        .body-svg { width: 150px; height: auto; }
        .muscle { fill: #cbd5e1; transition: 0.5s; }

        /* ENTRENAMIENTO */
        .workout-day-card { background: #f1f5f9; border-radius: 20px; padding: 15px; margin-bottom: 12px; border-left: 6px solid var(--primary); }
        .exercise-item { background: white; padding: 12px; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 6px; margin-top: 10px; }
        .set-box { height: 40px; border: 2px solid #e2e8f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #fff; font-size: 0.65rem; font-weight: 800; transition: 0.2s; }
        .set-box.done { background: var(--secondary); border-color: var(--secondary); color: white; transform: scale(0.95); }

        /* CHAT AI */
        #ai-chat-output { height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; font-size: 0.75rem; margin-bottom: 10px; line-height: 1.4; color: #e2e8f0; }

        /* BUTTONS */
        .btn-primary { width: 100%; padding: 15px; border-radius: 18px; border: none; background: var(--primary); color: white; font-weight: 900; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        .supp-pill { padding: 8px 15px; border-radius: 25px; font-size: 0.7rem; font-weight: 800; cursor: pointer; border: 2px solid #e2e8f0; background: white; text-align: center; }
        .supp-pill.active { background: var(--purple); color: white; border-color: var(--purple); }

        /* TIMER */
        .timer-overlay { position: fixed; bottom: 85px; right: 20px; background: var(--dark); color: white; padding: 12px 20px; border-radius: 50px; border: 2px solid var(--primary); display: none; z-index: 2000; font-weight: 900; box-shadow: 0 0 20px var(--primary); font-variant-numeric: tabular-nums; }
    </style>
</head>
<body>

<div id="rest-timer" class="timer-overlay">‚è±Ô∏è <span id="t-min">01</span>:<span id="t-sec">30</span></div>

<div class="container">
    <header><h1>‚ö° ELITE VANGUARD</h1></header>

    <!-- TABS SECTIONS -->
    
    <!-- SECTION: AGENDA & AI -->
    <section id="agenda" class="section active">
        <div class="card coach-card">
            <span class="coach-badge">Cerebro AI Vanguard</span>
            <div class="epi-badge" id="epi-score">EPI: --</div>
            <p id="coach-advice" style="font-size:0.85rem; line-height:1.5; margin-bottom:15px;">Calculando huella metab√≥lica y readiness...</p>
            
            <div id="ai-chat-output">Preg√∫ntame algo sobre tu progreso...</div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="ai-input" placeholder="Ej: ¬øPor qu√© no bajo de peso?" style="flex:1; padding:10px; border-radius:10px; border:none; font-size:0.8rem;">
                <button onclick="askCoach()" style="background:var(--indigo); color:white; border:none; padding:10px 15px; border-radius:10px; font-weight:800;">ENVIAR</button>
            </div>
        </div>
        
        <div class="card">
            <div id="cal-grid" class="calendar-grid"></div>
        </div>
    </section>

    <!-- SECTION: BIO & ANTRO -->
    <section id="bio" class="section">
        <div class="card" style="background: #f0fdf4; border: 1px solid #bbf7d0;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:center;">
                <div><label style="font-size:0.55rem; font-weight:900; color:#166534">MASA MAGRA (FFMI)</label><div style="font-size:1.2rem; font-weight:900;" id="curr-muscle">0 kg</div><div id="ffmi-val" style="font-size:0.7rem; font-weight:800; color:var(--primary)">FFMI: --</div></div>
                <div><label style="font-size:0.55rem; font-weight:900; color:var(--danger)">GRASA %</label><div style="font-size:1.2rem; font-weight:900; color:var(--danger)" id="curr-fat">0 kg</div><div id="perc-fat" style="font-size:0.7rem; font-weight:800; color:var(--danger)">0%</div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Mapa de Volumen Semanal</div>
            <div class="heatmap-container">
                <svg class="body-svg" viewBox="0 0 100 200">
                    <!-- Simple Humanoid for Heatmap -->
                    <circle cx="50" cy="20" r="12" class="muscle" id="heat-neck" />
                    <rect x="30" y="35" width="40" height="40" rx="5" class="muscle" id="heat-chest" />
                    <rect x="20" y="40" width="10" height="30" rx="3" class="muscle" id="heat-arms" />
                    <rect x="70" y="40" width="10" height="30" rx="3" class="muscle" id="heat-arms2" />
                    <rect x="32" y="80" width="16" height="50" rx="5" class="muscle" id="heat-legs" />
                    <rect x="52" y="80" width="16" height="50" rx="5" class="muscle" id="heat-legs2" />
                </svg>
            </div>
            <div style="font-size:0.6rem; text-align:center; color:#64748b;">Zonas oscuras = Mayor carga de trabajo acumulada</div>
        </div>

        <div class="card">
            <h2 class="card-title">Auditor√≠a Estructural (cm)</h2>
            <div class="config-grid">
                <div class="input-group"><label>B√≠ceps</label><input type="number" id="m-biceps" step="0.1"></div>
                <div class="input-group"><label>Muslo</label><input type="number" id="m-thigh" step="0.1"></div>
                <div class="input-group"><label>Cintura</label><input type="number" id="m-waist" step="0.1"></div>
                <div class="input-group"><label>Pecho</label><input type="number" id="m-chest" step="0.1"></div>
                <div class="input-group"><label>Gemelo</label><input type="number" id="m-calf" step="0.1"></div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Check-in Diario</h2>
            <div class="config-grid">
                <div class="input-group"><label>Peso (kg)</label><input type="number" id="log-w" step="0.1"></div>
                <div class="input-group"><label>Sue√±o (h)</label><input type="number" id="log-sleep" step="0.5"></div>
                <div class="input-group"><label>Energ√≠a (1-5)</label><input type="number" id="log-energy"></div>
                <div class="input-group"><label>Pasos</label><input type="number" id="log-steps" placeholder="10k"></div>
            </div>
            <button onclick="saveBio()" class="btn-primary" style="background:var(--accent)">EJECUTAR DIAGN√ìSTICO</button>
        </div>
    </section>

    <!-- SECTION: WORKOUT -->
    <section id="workout" class="section">
        <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:15px; color:white">
            <button class="nav-btn" onclick="changeWeek(-1)">‚óÄ</button>
            <div id="week-label" style="font-weight: 900; font-size: 1.2rem;">SEMANA 1</div>
            <button class="nav-btn" onclick="changeWeek(1)">‚ñ∂</button>
        </div>
        <div id="workout-render"></div>
    </section>

    <!-- SECTION: DIET -->
    <section id="nutrition" class="section">
        <div class="card" style="background: #fefce8; border: 2px solid var(--accent);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 class="card-title" style="border:none; color:#854d0e; margin:0;">Ciclado Metab√≥lico</h2>
                <div class="coach-badge" id="day-type-badge">Base</div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <div><span style="font-size:1.5rem; font-weight:900;" id="daily-target-kcal">2400</span> <small>kcal meta</small></div>
                <div id="weekly-balance-label" style="font-weight:900; font-size:0.75rem; color:var(--danger);"></div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Kit Suplementos</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <div class="supp-pill" id="supp-crea" onclick="toggleSupp('crea')">Creatina</div>
                <div class="supp-pill" id="supp-whey" onclick="toggleSupp('whey')">Prote√≠na</div>
                <div class="supp-pill" id="supp-citru" onclick="toggleSupp('citru')">Citrulina</div>
            </div>
        </div>

        <div class="card">
            <input type="text" class="search-input" id="food-search" placeholder="Buscar alimento..." style="width:100%; padding:12px; border-radius:14px; border:2px solid var(--border);">
            <div id="selected-ui" style="display:none; margin-top:15px; background:#f1f5f9; padding:15px; border-radius:18px;">
                <h3 id="si-name" style="font-size:0.9rem; font-weight:900;"></h3>
                <div class="config-grid"><div class="input-group"><label>Cant (g/u)</label><input type="number" id="si-qty" value="100" oninput="calcItem()"></div></div>
                <button onclick="addItem()" class="btn-primary" style="background:var(--secondary)">‚ûï REGISTRAR</button>
            </div>
        </div>
        <div id="diary-list"></div>
    </section>

    <!-- SECTION: ADJUSTMENTS -->
    <section id="config" class="section">
        <div class="card">
            <h2 class="card-title">‚öôÔ∏è Par√°metros Fisiol√≥gicos</h2>
            <div class="config-grid">
                <div class="input-group"><label>Kcal Base</label><input type="number" id="body-kcal" value="2400"></div>
                <div class="input-group"><label>Altura (cm)</label><input type="number" id="body-h" value="175"></div>
                <div class="input-group"><label>% Grasa Meta</label><input type="number" id="goal-f" value="12"></div>
            </div>
            <div class="config-grid" style="margin-top:15px;">
                <div class="input-group"><label>Banca kg</label><input type="number" id="base-bp" value="80"></div>
                <div class="input-group"><label>Sentadilla kg</label><input type="number" id="base-sq" value="100"></div>
                <div class="input-group"><label>P. Muerto kg</label><input type="number" id="base-dl" value="120"></div>
            </div>
            <button onclick="saveConfig()" class="btn-primary" style="margin-top:20px;">üöÄ GUARDAR TODO</button>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="exportData()" class="btn-primary" style="flex:1; background:var(--dark); font-size:0.7rem;">COPIAR BACKUP</button>
                <button onclick="importData()" class="btn-primary" style="flex:1; background:var(--accent); font-size:0.7rem;">RESTAURAR</button>
            </div>
        </div>
    </section>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="tab('agenda')"><span class="icon">üìÖ</span>Agenda</button>
        <button class="nav-btn" onclick="tab('workout')"><span class="icon">üí™</span>Entreno</button>
        <button class="nav-btn" onclick="tab('bio')"><span class="icon">‚öñÔ∏è</span>Bio</button>
        <button class="nav-btn" onclick="tab('nutrition')"><span class="icon">ü•ó</span>Dieta</button>
        <button class="nav-btn" onclick="tab('config')"><span class="icon">‚öôÔ∏è</span>Ajustes</button>
    </div>
</div>

<script>
    // API CONFIG (SIN KEY, SE PROVEE EN RUNTIME)
    const apiKey = "";
    
    // DB DE ALIMENTOS BASE
    const foodDB = [
        { n: "Pollo Cocido", c: 165, p: 31, cho: 0, f: 3.6, type: 'food' },
        { n: "Arroz Blanco", c: 130, p: 2.7, cho: 28, f: 0.3, type: 'food' },
        { n: "Alfajor Terrabusi", c: 202, p: 3, cho: 20, f: 8, type: 'food', m: 'unid' },
        { n: "Huevo Entero", c: 155, p: 13, cho: 1, f: 11, type: 'food', m: 'unid' }
    ];

    let state = {
        week: 1, water: 0, supps: {}, measurements: {}, epi: 0,
        weights: { sq: 100, bp: 80, dl: 120, body: 80, h: 175, fCurr: 15, fGoal: 12, goal: 2400 },
        diary: [], bio: [], doneSets: {}, agenda: {}, archi: {}, tonnage: { legs: 0, chest: 0, back: 0, arms: 0 }
    };

    window.onload = () => {
        const saved = localStorage.getItem('elite_master_vfinal_v1');
        if (saved) { 
            state = JSON.parse(saved); 
            // Migraci√≥n para campos nuevos si es necesario
            if(!state.tonnage) state.tonnage = { legs: 0, chest: 0, back: 0, arms: 0 };
        }
        loadConfigFields();
        renderAll();
    };

    function save() { localStorage.setItem('elite_master_vfinal_v1', JSON.stringify(state)); }

    function tab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'agenda') renderCalendar();
    }

    function renderAll() {
        document.getElementById('week-label').innerText = `SEMANA ${state.week}`;
        updateCoachVanguard();
        renderWorkout();
        renderDiary();
        renderBio();
        renderCalendar();
        updateWaterUI();
        renderSupps();
        updateHeatmap();
    }

    // PILLAR: COACH AI GEMINI INTEGRATION
    async function askCoach() {
        const input = document.getElementById('ai-input');
        const output = document.getElementById('ai-chat-output');
        const query = input.value;
        if(!query) return;

        output.innerText = "Pensando como cient√≠fico de √©lite...";
        input.value = "";

        const context = `Eres un Coach de Alto Rendimiento. Datos del atleta: Peso ${state.weights.body}kg, Grasa ${state.weights.fCurr}%, Altura ${state.weights.h}cm. Fase actual semana ${state.week} de un programa 8x8. √öltimo sue√±o: ${state.bio[0]?.sleep || 'no registrado'}. Responde de forma t√©cnica pero motivadora en espa√±ol.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Contexto: ${context}. Pregunta: ${query}` }] }]
                })
            });
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No pude procesar la consulta.";
            output.innerText = text;
        } catch (e) {
            output.innerText = "Error de conexi√≥n. Intenta de nuevo.";
        }
    }

    // PILLAR: ENTRENAMIENTO + TEMPO + TONELAJE
    function renderWorkout() {
        const step = (state.week - 1) % 5;
        const sets = step === 4 ? 4 : 5 + step;
        const reps = step === 4 ? 8 : 5 + step;
        const wInc = 1 + (Math.floor((state.week - 1) / 5) * 0.025);
        const w = { sq: (state.weights.sq * wInc).toFixed(1), bp: (state.weights.bp * wInc).toFixed(1), dl: (state.weights.dl * wInc).toFixed(1) };
        
        const days = [
            { n: `D1: Piernas & Gemelos (${sets}x${reps})`, muscle: 'legs', exs: [{id:"sq1", n:"Sentadilla", w:w.sq, s:sets, r:reps, t:"3-0-1-0"}, {id:"gm1", n:"Gemelos", w:state.weights.body, s:3, r:15, t:"2-2-1-0"}]},
            { n: `D2: Mirror & Tracci√≥n (${sets}x${reps})`, muscle: 'back', exs: [{id:"bp2", n:"Banca (D1 Mirror)", w:w.bp, s:sets, r:reps, t:"3-1-1-0", m:'chest'}, {id:"re2", n:"Remo Barra", w:w.bp, s:sets, r:10, t:"2-0-1-1", m:'back'}, {id:"fp2", n:"Face Pulls", w:"Luz", s:3, r:15, t:"2-1-1-1", m:'back'}]},
            { n: `D3: Cadena Posterior (${sets}x${reps})`, muscle: 'legs', exs: [{id:"dl3", n:"Peso Muerto", w:w.dl, s:Math.min(sets,5), r:5, t:"X-X-1-0"}, {id:"sq3", n:"Sent. Var.", w:(w.sq*0.7).toFixed(1), s:3, r:12, t:"4-0-1-0"}]}
        ];

        document.getElementById('workout-render').innerHTML = days.map(day => `
            <div class="workout-day-card">
                <h3>${day.n}</h3>
                ${day.exs.map(ex => `
                    <div class="exercise-item">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong>${ex.n}</strong>
                            <div><span class="tempo-tag">Tempo ${ex.t}</span><span style="margin-left:5px; font-weight:900;">${ex.w}kg</span></div>
                        </div>
                        <div class="sets-grid">${Array(ex.s).fill().map((_,i) => { 
                            const k = `w${state.week}_${ex.id}_s${i}`; 
                            return `<div class="set-box ${state.doneSets[k] ? 'done' : ''}" onclick="toggleSet('${k}', '${ex.m || day.muscle}', ${parseFloat(ex.w)||0}, ${ex.r})">S${i+1}</div>`; 
                        }).join('')}</div>
                    </div>`).join('')}
            </div>`).join('');
    }

    function toggleSet(k, muscle, weight, reps) {
        state.doneSets[k] = !state.doneSets[k];
        if(state.doneSets[k]) {
            state.tonnage[muscle] = (state.tonnage[muscle] || 0) + (weight * reps);
            startRest(); 
        } else {
            state.tonnage[muscle] = Math.max(0, (state.tonnage[muscle] || 0) - (weight * reps));
        }
        save(); renderAll();
    }

    function startRest() {
        clearInterval(window.t); 
        let rpe = parseInt(prompt("RPE de la serie (1-10)?")) || 8;
        let t = rpe >= 9 ? 180 : 90;
        document.getElementById('rest-timer').style.display = 'block'; 
        window.t = setInterval(() => { 
            t--; 
            document.getElementById('t-min').innerText = Math.floor(t/60).toString().padStart(2,'0'); 
            document.getElementById('t-sec').innerText = (t%60).toString().padStart(2,'0'); 
            if(t<=0){clearInterval(window.t); document.getElementById('rest-timer').style.display='none';} 
        }, 1000);
    }

    // PILLAR: BIO + FFMI + HEATMAP
    function saveBio() {
        const w = parseFloat(document.getElementById('log-w').value);
        const f = parseFloat(document.getElementById('log-f').value);
        if(w) state.weights.body = w; if(f) state.weights.fCurr = f;
        const ms = ['chest','waist','biceps','thigh','calf','neck'];
        const currentM = {}; ms.forEach(m => { currentM[m] = parseFloat(document.getElementById(`m-${m}`).value) || state.measurements[m] || 0; state.measurements[m] = currentM[m]; });
        
        state.bio.unshift({
            w, f, sleep: document.getElementById('log-sleep').value, steps: document.getElementById('log-steps').value,
            date: new Date().toLocaleDateString(), dateObj: new Date().getTime(), m: currentM
        });
        save(); renderAll();
    }

    function renderBio() {
        const w = state.weights.body; const f = state.weights.fCurr;
        const fatKg = (w * (f/100)).toFixed(1); const muscKg = (w - fatKg).toFixed(1);
        document.getElementById('curr-muscle').innerText = muscKg + " kg";
        document.getElementById('curr-fat').innerText = fatKg + " kg";
        document.getElementById('perc-fat').innerText = f + "%";
        
        // FFMI
        const hM = state.weights.h / 100;
        const ffmi = (muscKg / (hM * hM)).toFixed(1);
        document.getElementById('ffmi-val').innerText = `FFMI: ${ffmi} (Nat. Limit: 25)`;
        
        document.getElementById('bio-list').innerHTML = state.bio.slice(0,5).map(b => `<div style="font-size:0.7rem; padding:8px; border-bottom:1px solid #eee;"><b>${b.date}</b>: ${b.w}kg | FFMI: ${( (b.w - (b.w*(b.f/100))) / (Math.pow(state.weights.h/100, 2)) ).toFixed(1)}</div>`).join('');
    }

    function updateHeatmap() {
        const muscles = ['legs', 'chest', 'back', 'neck'];
        const maxTon = 5000; // Tonalaje de referencia para color m√°ximo
        muscles.forEach(m => {
            const val = state.tonnage[m] || 0;
            const intensity = Math.min(100, (val / maxTon) * 100);
            const el = document.getElementById(`heat-${m}`);
            const el2 = document.getElementById(`heat-${m}2`);
            if(el) el.style.fill = `rgb(37, 99, ${Math.round(235 - intensity * 1.5)})`;
            if(el2) el2.style.fill = `rgb(37, 99, ${Math.round(235 - intensity * 1.5)})`;
            if(intensity > 50) el.style.fill = `rgb(${Math.round(37 + intensity)}, 99, 235)`;
        });
    }

    // PILLAR: COACH VANGUARD INTELLIGENCE
    function updateCoachVanguard() {
        const coachEl = document.getElementById('coach-advice');
        const epiEl = document.getElementById('epi-score');
        const targetKcalEl = document.getElementById('daily-target-kcal');
        
        const lastBio = state.bio[0] || {};
        let score = 50;
        if(lastBio.sleep >= 8) score += 30;
        if(state.water >= 3000) score += 20;
        epiEl.innerText = `EPI: ${score}`;

        if(score < 60) coachEl.innerHTML = "üî¥ <b>NEURAL FATIGUE:</b> Sistema Nervioso agotado. Hoy el 8x8 es contraproducente. Haz 3x10 ligero y vete a casa.";
        else if (state.tonnage.legs > state.tonnage.chest * 1.5) coachEl.innerHTML = "‚ö†Ô∏è <b>SIMETR√çA:</b> El volumen de pierna dobla al torso. Prioriza la Banca y el Remo esta sesi√≥n.";
        else coachEl.innerHTML = "üöÄ <b>PRONTO PARA LA GLORIA:</b> Biomarcadores √≥ptimos. Hoy es d√≠a de subir 1.25kg a cada lado del b√°sico.";
        
        targetKcalEl.innerText = state.weights.goal;
    }

    // UTILS
    function addWater(ml) { state.water = Math.max(0, (state.water || 0) + ml); save(); updateWaterUI(); }
    function updateWaterUI() { let goal = Math.round(state.weights.body * 35); const pct = Math.min(100, ((state.water || 0) / goal) * 100); document.getElementById('water-status').innerText = `${state.water || 0} / ${goal} ml`; document.getElementById('water-bar').style.width = `${pct}%`; }
    function toggleSupp(id) { const t = new Date().toLocaleDateString(); if(!state.supps[t]) state.supps[t] = []; const i = state.supps[t].indexOf(id); if(i > -1) state.supps[t].splice(i,1); else state.supps[t].push(id); save(); renderSupps(); }
    function renderSupps() { const t = new Date().toLocaleDateString(); const a = state.supps[t] || []; ['crea', 'whey', 'citru'].forEach(id => { const el = document.getElementById(`supp-${id}`); if(a.includes(id)) el.classList.add('active'); else el.classList.remove('active'); }); }
    function renderCalendar() { const grid = document.getElementById('cal-grid'); const now = new Date(); const total = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(); let html = ''; for(let d=1; d<=total; d++) { const s = `${now.getFullYear()}-${now.getMonth()+1}-${d}`; const acts = state.agenda[s] || []; html += `<div class="day-cell ${d === now.getDate() ? 'today' : ''}"><span style="font-size:0.6rem; font-weight:900;">${d}</span>${acts.map(a => `<div class="activity-indicator" style="background:var(--primary); height:4px; width:80%; margin-top:2px; border-radius:2px;"></div>`).join('')}</div>`; } grid.innerHTML = html; }
    function loadConfigFields() { document.getElementById('body-kcal').value = state.weights.goal; document.getElementById('body-h').value = state.weights.h; document.getElementById('base-bp').value = state.weights.bp; document.getElementById('base-sq').value = state.weights.sq; document.getElementById('base-dl').value = state.weights.dl; }
    function saveConfig() { state.weights.goal = parseFloat(document.getElementById('body-kcal').value); state.weights.h = parseFloat(document.getElementById('body-h').value); state.weights.bp = parseFloat(document.getElementById('base-bp').value); state.weights.sq = parseFloat(document.getElementById('base-sq').value); state.weights.dl = parseFloat(document.getElementById('base-dl').value); save(); renderAll(); alert("Vanguard Master Sincronizado"); }
    function exportData() { navigator.clipboard.writeText(JSON.stringify(state)); alert("Respaldo copiado."); }
    function importData() { const d = prompt("Pega c√≥digo:"); if(d){ state = JSON.parse(d); save(); location.reload(); } }
    function changeWeek(d) { state.week = Math.max(1, state.week + d); save(); renderAll(); }

    function addItem() { /* L√≥gica de buscador igual a versiones anteriores para rapidez */ }
    function renderDiary() { /* L√≥gica igual */ }

    renderAll();
</script>
</body>
</html>
